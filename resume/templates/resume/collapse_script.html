<script>
    document.addEventListener("DOMContentLoaded", function() {
        // Collapsible section for Add buttons
        var coll = document.getElementsByClassName("collapsible");
        for (var i = 0; i < coll.length; i++) {
            coll[i].addEventListener("click", function() {
                this.classList.toggle("active");
                var content = this.nextElementSibling;
                if (content.style.display === "block") {
                    content.style.display = "none";
                    this.innerHTML = this.getAttribute("data-original-text")
                } else {
                    // Save the original text in a data attribute
                    if (!this.getAttribute("data-original-text")) {
                        this.setAttribute("data-original-text", this.innerHTML);
                    }
                    content.style.display = "block";
                    this.innerHTML = " âˆ’ ";
                }
            });
        }

        // Debugging: Check if flatpickr is loaded
        if (typeof flatpickr !== 'undefined') {
            console.log('flatpickr is loaded');
        } else {
            console.error('flatpickr is not loaded');
        }

        // Initialize flatpickr with monthSelect plugin for month/year-only selection
        const startDateInputs = document.querySelectorAll('input[name="start_date"]');
        const endDateInputs = document.querySelectorAll('input[name="end_date"]');
        const issueDateInputs = document.querySelectorAll('input[name="issue_date"]');
        const expirationDateInputs = document.querySelectorAll('input[name="expiration_date"]');
        const date_receivedInputs = document.querySelectorAll('input[name="date_received"]');

        const monthPickerOptions = {
            plugins: [new monthSelectPlugin({ shorthand: false })],
            // Keep the stored value as a full date so Django DateField accepts it.
            // We'll normalize to the first day of the month on change.
            dateFormat: 'Y-m-d',
            altInput: true,
            altFormat: 'm/Y',
            onChange: function(selectedDates, dateStr, instance) {
                if (selectedDates && selectedDates.length) {
                    const d = selectedDates[0];
                    const normalized = new Date(d.getFullYear(), d.getMonth(), 1);
                    // write ISO YYYY-MM-DD into the real input
                    instance.input.value = normalized.toISOString().slice(0,10);
                    // set visible alt input to MM/YYYY
                    if (instance.altInput) instance.altInput.value = ("0" + (normalized.getMonth()+1)).slice(-2) + "/" + normalized.getFullYear();
                }
            }
        };

        startDateInputs.forEach(i => flatpickr(i, monthPickerOptions));
        endDateInputs.forEach(i => flatpickr(i, monthPickerOptions));
        issueDateInputs.forEach(i => flatpickr(i, monthPickerOptions));
        expirationDateInputs.forEach(i => flatpickr(i, monthPickerOptions));
        date_receivedInputs.forEach(i => flatpickr(i, monthPickerOptions));

        {% comment %} // Initialize sortable sections. Commented out for now since not in use and still being tested.
        const sortableSections = [
            {id: 'experiences-list', url: '{% url "update-experience-position" %}'},
            {id: 'educations-list', url: '{% url "update-education-position" %}'},
            {id: 'skills-list', url: '{% url "update-skill-position" %}'},
            {id: 'projects-list', url: '{% url "update-project-position" %}'},
            {id: 'certifications-list', url: '{% url "update-certification-position" %}'}
        ]; {% endcomment %}

        // --- Inline Edit Functionality (new code below) ---

        // Handle Edit Inline buttons (for all sections)
        document.querySelectorAll('.edit-collapsible').forEach(function(btn) {
            btn.addEventListener('click', function() {
                // Optionally close all other open edit forms
                document.querySelectorAll('.edit-content').forEach(function(box) { box.style.display = "none"; });
                // Open the correct edit form for this button
                var target = document.querySelector(btn.getAttribute('data-target'));
                if (target) target.style.display = "block";
            });
        });

        // Handle Cancel buttons inside Edit forms
        document.querySelectorAll('.close-edit').forEach(function(btn) {
            btn.addEventListener('click', function() {
                var target = document.querySelector(btn.getAttribute('data-target'));
                if (target) target.style.display = "none";
            });
        });

    });
</script>
